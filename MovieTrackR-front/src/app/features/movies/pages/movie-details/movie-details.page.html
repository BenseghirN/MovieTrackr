<div class="movie-details-page">
  @if (loading()) {
    <div class="loading-container">
      <p-progressSpinner></p-progressSpinner>
    </div>
  }

  @if (error()) {
    <div class="error-message">
      <i class="pi pi-exclamation-triangle"></i>
      {{ error() }}
    </div>
  }

  @if (movie(); as movie) {
    @if (movie.backdropPath) {
      <div class="backdrop">
        <img
          [src]="imageService.getBackdropUrl(movie.backdropPath, 'w1280')"
          [alt]="movie.title"
        />
        <div class="backdrop-overlay"></div>
      </div>
    } @else {
      <div class="backdrop backdrop-placeholder"></div>
    }

    <div class="content">
      <div class="movie-header">
        <div class="poster">
          <img
            [src]="imageService.getPosterUrl(movie.posterUrl, 'w500')"
            [alt]="movie.title"
          />
        </div>

        <div class="info">
          <h1>{{ movie.title }}</h1>

          @if (movie.originalTitle && movie.originalTitle !== movie.title) {
            <p class="original-title">{{ movie.originalTitle }}</p>
          }

          <div class="meta">
            @if (movie.year) {
              <span class="meta-pill">
                <i class="pi pi-calendar"></i>
                {{ movie.year }}
              </span>
            }

            @if (movie.duration) {
              <span class="meta-pill">
                <i class="pi pi-clock"></i>
                {{ formatDuration(movie.duration) }}
              </span>
            }

            @if (movie.voteAverage) {
              <span class="meta-pill rating-pill">
                <i class="pi pi-star-fill"></i>
                {{ movie.voteAverage | number: '1.1-1' }}/10
              </span>
            }
          </div>

          @if (movie.genres.length > 0) {
            <div class="genres">
              @for (genre of movie.genres; track genre.id) {
                <p-chip [label]="genre.name"></p-chip>
              }
            </div>
          }

          @if (director(); as director) {
            <p class="director">
              <strong>Réalisateur :</strong> {{ director }}
            </p>
          }

          @if (movie.overview) {
            <div class="overview">
              <h2>Synopsis</h2>
              <p>{{ movie.overview }}</p>
            </div>
          }

          <div class="actions">
            <p-button
              label="Ajouter à ma watchlist"
              icon="pi pi-bookmark"
              [outlined]="true"
              styleClass="action-button primary"
            ></p-button>

            @if (movie.trailerUrl) {
              <p-button
                label="Voir la bande-annonce"
                icon="pi pi-play"
                severity="secondary"
                styleClass="action-button secondary"
                (onClick)="openTrailer(movie.trailerUrl)"
              ></p-button>
            }            
            <p-dialog
              [visible]="trailerDialogVisible()"
              [modal]="true"
              [dismissableMask]="true"
              [style]="{ width: '800px', maxWidth: '95vw' }"
              (visibleChange)="onTrailerDialogVisibleChange($event)"
            >
              <div class="trailer-wrapper">
                @if (currentTrailerUrl()) {
                  <iframe
                    width="100%"
                    height="100%"
                    [src]="currentTrailerUrl() | safeUrl"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    allowfullscreen>
                  </iframe>
                }
              </div>
            </p-dialog>
          </div>
        </div>
      </div>

      @if (movie.cast.length > 0) {
        <div class="section">
          <div class="section-header">
            <h2>Distribution</h2>
            <span class="section-subtitle">
              {{ movie.cast.length }} acteur(s)
            </span>
          </div>
          <p-carousel
            [value]="movie.cast"
            [numVisible]="7"
            [numScroll]="2"
            [circular]="true"
            [responsiveOptions]="carouselResponsiveOptions"
            styleClass="cast-carousel"
          >
            <ng-template pTemplate="item" let-actor>
              <p-card styleClass="cast-card">
                <ng-template pTemplate="header">
                  <div class="cast-photo">
                    <img
                      [src]="imageService.getPosterUrl(actor.profilePath, 'w185')"
                      [alt]="actor.name"
                      loading="lazy"
                    />
                  </div>
                </ng-template>
                <div class="cast-info">
                  <p class="cast-name">{{ actor.name }}</p>
                  @if (actor.character) {
                    <p class="cast-character">{{ actor.character }}</p>
                  }
                </div>
              </p-card>
              <!-- <article class="cast-card">
                <div class="cast-photo">
                  <img
                    [src]="imageService.getPosterUrl(actor.profilePath, 'w185')"
                    [alt]="actor.name"
                  />
                </div>
                <div class="cast-info">
                  <p class="cast-name">{{ actor.name }}</p>
                  @if (actor.character) {
                    <p class="cast-character">{{ actor.character }}</p>
                  }
                </div>
              </article> -->
            </ng-template>
          </p-carousel>
        </div>
      }
    </div>
    <div>
      <app-movie-reviews
        [movieId]="movie.id"
      />
    </div>
  }
</div>
