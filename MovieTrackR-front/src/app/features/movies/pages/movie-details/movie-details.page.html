<div class="movie-details-page">
  @if (loading()) {
    <div class="loading-container">
      <p-progressSpinner></p-progressSpinner>
    </div>
  }

  @if (error()) {
    <div class="error-message">
      <i class="pi pi-exclamation-triangle"></i>
      {{ error() }}
    </div>
  }

  @if (movie(); as movie) {
    @if (movie.backdropPath) {
      <div class="backdrop">
        <img
          [src]="imageService.getBackdropUrl(movie.backdropPath, 'w1280')"
          [alt]="movie.title"
        />
        <div class="backdrop-overlay"></div>
      </div>
    } @else {
      <div class="backdrop backdrop-placeholder"></div>
    }

    <div class="content">
      <div class="movie-header">
        <div 
          class="poster-flip-container" 
          [class.flipped]="posterFlipped()" 
          (click)="togglePosterFlip()"
        >
          <div class="poster-inner">
            <div class="poster-face poster-front">
              <img
                [src]="imageService.getPosterUrl(movie.posterUrl, 'w500')"
                [alt]="movie.title"
              />

              <button 
                type="button" 
                class="where-to-watch-tag"
                (click)="togglePosterFlip(); $event.stopPropagation()"
              >
                <span class="label">Où regarder ?</span>
                <i class="pi pi-angle-up"></i>
              </button>
            </div>

            <div class="poster-face poster-back">
              <div class="providers-header">
                <div class="title">
                  <span>Où regarder</span>
                  @if (streamingOffers(); as offers) {
                    <small>{{ offers.country }}</small>
                  }
                </div>

                <button 
                  type="button" 
                  class="close-flip" 
                  (click)="togglePosterFlip(); $event.stopPropagation()"
                >
                  <i class="pi pi-times"></i>
                </button>
              </div>

              @if (streamingLoading()) {
                <div class="providers-loading">
                  <p-progressSpinner></p-progressSpinner>
                </div>
              } @else if (streamingError()) {
                <p class="providers-error">{{ streamingError() }}</p>
              } @else if (streamingOffers(); as offers) {
                <div class="providers-groups">
                  @if (offers.flatrate.length) {
                    <div class="providers-group">
                      <span class="group-title">En streaming</span>
                      <div class="provider-logos">
                        @for (p of offers.flatrate; track p.providerId) {
                          <button
                            type="button"
                            class="provider-logo"
                            (click)="openStreamingLink(offers.link, $event)"
                          >
                            <img [src]="p.logoPath" [alt]="p.providerName" />
                          </button>
                        }
                      </div>
                    </div>
                  }

                  @if (offers.free.length) {
                    <div class="providers-group">
                      <span class="group-title">Gratuit</span>
                      <div class="provider-logos">
                        @for (p of offers.free; track p.providerId) {
                          <button
                            type="button"
                            class="provider-logo"
                            (click)="openStreamingLink(offers.link, $event)"
                          >
                            <img [src]="p.logoPath" [alt]="p.providerName" />
                          </button>
                        }
                      </div>
                    </div>
                  }
                </div>

                @if (!offers.flatrate.length && !offers.free.length) {
                  <p class="providers-empty">
                    Pas d'offres de streaming connues pour ce pays.
                  </p>
                }

                @if (offers.link) {
                  <button
                    type="button"
                    class="providers-tmdb-link"
                    (click)="openStreamingLink(offers.link, $event)"
                  >
                    Voir les offres détaillées sur TMDb
                  </button>
                }
              } @else {
                <p class="providers-empty">
                  Pas d'information de streaming pour ce film.
                </p>
              }
            </div>
          </div>
        </div>

        <div class="info">
          <h1>{{ movie.title }}</h1>

          @if (movie.originalTitle && movie.originalTitle !== movie.title) {
            <p class="original-title">{{ movie.originalTitle }}</p>
          }

          @if (movie.tagline) {
            <p class="tagline">{{ movie.tagline }}</p>
          }

          <div class="meta">
            @if (movie.year) {
              <span class="meta-pill">
                <i class="pi pi-calendar"></i>
                {{ movie.year }}
              </span>
            }

            @if (movie.duration) {
              <span class="meta-pill">
                <i class="pi pi-clock"></i>
                {{ formatDuration(movie.duration) }}
              </span>
            }

            @if (movie.voteAverage) {
              <span class="meta-pill rating-pill">
                <i class="pi pi-star-fill"></i>
                TMDB: {{ movie.voteAverage | number: '1.1-1' }}/10 
              </span>
            }
            
            @if (movie.averageRating) {
              <span class="meta-pill rating-pill">
                <i class="pi pi-star-fill"></i>
                MovieTrackR: {{ movie.averageRating | number: '1.1-1' }}/5
              </span>
            }
          </div>

          @if (movie.genres.length > 0) {
            <div class="genres">
              @for (genre of movie.genres; track genre.id) {
                <p-chip [label]="genre.name"></p-chip>
              }
            </div>
          }

          @if (director(); as director) {
            <p class="director">
              <strong>Réalisateur :</strong> {{ director }}
            </p>
          }

          @if (movie.overview) {
            <div class="overview">
              <h2>Synopsis</h2>
              <p>{{ movie.overview }}</p>
            </div>
          }

          <div class="actions">
            <p-button
              label="Ajouter à ma watchlist"
              icon="pi pi-bookmark"
              [outlined]="true"
              styleClass="action-button primary"
            ></p-button>

            @if (movie.trailerUrl) {
              <p-button
                label="Voir la bande-annonce"
                icon="pi pi-play"
                severity="secondary"
                styleClass="action-button secondary"
                (onClick)="openTrailer(movie.trailerUrl)"
              ></p-button>
            }            
            <p-dialog
              [visible]="trailerDialogVisible()"
              [modal]="true"
              [dismissableMask]="true"
              [style]="{ width: '800px', maxWidth: '95vw' }"
              (visibleChange)="onTrailerDialogVisibleChange($event)"
            >
              <div class="trailer-wrapper">
                @if (currentTrailerUrl()) {
                  <iframe
                    width="100%"
                    height="100%"
                    [src]="currentTrailerUrl() | safeUrl"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    allowfullscreen>
                  </iframe>
                }
              </div>
            </p-dialog>
          </div>
        </div>
      </div>

      @if (movie.cast.length > 0) {
        <div class="section">
          <div class="section-header">
            <h2>Distribution</h2>
            <span class="section-subtitle">
              {{ movie.cast.length }} acteur(s)
            </span>
          </div>
          <p-carousel
            [value]="movie.cast"
            [numVisible]="7"
            [numScroll]="2"
            [circular]="true"
            [responsiveOptions]="carouselResponsiveOptions"
            styleClass="cast-carousel"
          >
            <ng-template pTemplate="item" let-actor>
              <p-card styleClass="cast-card">
                <ng-template pTemplate="header">
                  <div class="cast-photo">
                    <img
                      [src]="imageService.getPosterUrl(actor.profilePath, 'w185')"
                      [alt]="actor.name"
                      loading="lazy"
                    />
                  </div>
                </ng-template>
                <div class="cast-info">
                  <p class="cast-name">{{ actor.name }}</p>
                  @if (actor.character) {
                    <p class="cast-character">{{ actor.character }}</p>
                  }
                </div>
              </p-card>
            </ng-template>
          </p-carousel>
        </div>
      }
    </div>
    <div class="reviews-section">
      <app-movie-reviews
        [movieId]="movie.id"
        [averageRating]="movie.averageRating"
      />
    </div>
  }
</div>
