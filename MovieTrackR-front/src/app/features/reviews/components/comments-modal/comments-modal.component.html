<div class="comments-modal">
  <div class="modal-header">
    <div class="header-info">
      <h3>Commentaires</h3>
      <span class="review-author">sur la critique de {{ reviewAuthor }}</span>
    </div>
    <p-button
      icon="pi pi-times"
      [text]="true"
      [rounded]="true"
      severity="secondary"
      (onClick)="onClose()"
    />
  </div>

  <div class="modal-body">
    @if (isAuthenticated()) {
      <div class="comment-form-section">
        <form [formGroup]="commentForm" (ngSubmit)="onSubmit()">
          <div class="form-group">
            <label class="form-label">
              @if (editingCommentId()) {
                <span>Modifier votre commentaire</span>
              } @else {
                <span>Ajouter un commentaire</span>
              }
              <span class="char-count" [class.error]="contentLength() < 3 || contentLength() > 500">
                {{ contentLength() }}/500
              </span>
            </label>
            
            <textarea
              pTextarea
              formControlName="content"
              rows="3"
              placeholder="Partagez votre avis sur cette critique..."
              [style]="{ resize: 'vertical', width: '100%' }"
            ></textarea>

            @if (commentForm.controls.content.invalid && commentForm.controls.content.touched) {
              <div class="error-message">
                @if (commentForm.controls.content.hasError('required')) {
                  <small>Le commentaire est obligatoire</small>
                }
                @if (commentForm.controls.content.hasError('minlength')) {
                  <small>Le commentaire doit contenir au moins 3 caractères</small>
                }
                @if (commentForm.controls.content.hasError('maxlength')) {
                  <small>Le commentaire ne peut pas dépasser 500 caractères</small>
                }
              </div>
            }
          </div>

          <div class="form-actions">
            @if (editingCommentId()) {
              <p-button
                label="Annuler"
                severity="secondary"
                [outlined]="true"
                type="button"
                size="small"
                (onClick)="onCancelEdit()"
              />
            }
            
            <p-button
              [label]="editingCommentId() ? 'Modifier' : 'Publier'"
              icon="pi pi-send"
              type="submit"
              size="small"
              [disabled]="!canSubmit()"
              [loading]="submitting()"
            />
          </div>
        </form>
      </div>
    } @else {
      <div class="login-prompt">
        <i class="pi pi-user"></i>
        <p>
          <a (click)="login()">Connectez-vous</a>
          pour commenter cette critique
        </p>
      </div>
    }

    <div class="comments-section">
      @if (loading()) {
        <div class="loading-container">
          <p-progressSpinner />
        </div>
      } @else if (hasComments()) {
        <p-scrollPanel [style]="{ width: '100%', height: '250px' }">
          <div class="comments-list-content">
            @for (comment of comments(); track comment.id) {
              <div class="comment-item">
                <div class="comment-header">
                  <div class="comment-author">
                    <div class="author-avatar">
                      {{ comment.userName.charAt(0).toUpperCase() }}
                    </div>
                    <div class="author-info">
                      <span class="author-name">{{ comment.userName }}</span>
                      <span class="comment-date">{{ comment.createdAt | date:'dd/MM/yyyy à HH:mm' }}</span>
                    </div>
                  </div>

                  @if (isMyComment(comment)) {
                    <div class="comment-actions">
                      <p-button
                        icon="pi pi-pencil"
                        [text]="true"
                        [rounded]="true"
                        size="small"
                        severity="secondary"
                        (onClick)="onEdit(comment)"
                        pTooltip="Modifier"
                      />
                      <p-button
                        icon="pi pi-trash"
                        [text]="true"
                        [rounded]="true"
                        size="small"
                        severity="danger"
                        (onClick)="onDelete(comment.id)"
                        pTooltip="Supprimer"
                      />
                    </div>
                  }
                </div>

                <div class="comment-content">
                  <p>{{ comment.content }}</p>
                </div>
              </div>
            }
          </div>
        </p-scrollPanel>
        <!-- <div class="comments-list">
          @for (comment of comments(); track comment.id) {
            <div class="comment-item">
              <div class="comment-header">
                <div class="comment-author">
                  <div class="author-avatar">
                    {{ comment.userName.charAt(0).toUpperCase() }}
                  </div>
                  <div class="author-info">
                    <span class="author-name">{{ comment.userName }}</span>
                    <span class="comment-date">{{ comment.createdAt | date:'dd/MM/yyyy à HH:mm' }}</span>
                  </div>
                </div>

                @if (isMyComment(comment)) {
                  <div class="comment-actions">
                    <p-button
                      icon="pi pi-pencil"
                      [text]="true"
                      [rounded]="true"
                      size="small"
                      severity="secondary"
                      (onClick)="onEdit(comment)"
                      pTooltip="Modifier"
                    />
                    <p-button
                      icon="pi pi-trash"
                      [text]="true"
                      [rounded]="true"
                      size="small"
                      severity="danger"
                      (onClick)="onDelete(comment.id)"
                      pTooltip="Supprimer"
                    />
                  </div>
                }
              </div>

              <div class="comment-content">
                <p>{{ comment.content }}</p>
              </div>
            </div>
          }
        </div> -->

        @if (totalPages() > 1) {
          <p-paginator
            [rows]="pageSize()"
            [totalRecords]="totalCount()"
            [first]="(currentPage() - 1) * pageSize()"
            [rowsPerPageOptions]="[10, 20, 50]"
            (onPageChange)="onPageChange($event)"
          />
        }
      } @else {
        <div class="no-comments">
          <i class="pi pi-comments"></i>
          <p>Aucun commentaire pour le moment</p>
          @if (isAuthenticated()) {
            <small>Soyez le premier à commenter !</small>
          }
        </div>
      }
    </div>
  </div>
</div>